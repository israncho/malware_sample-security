from Crypto.Cipher import AES, PKCS1_OAEP
from encrypt import all_files, delete_file
from tools import get_venv_var, read_bytes, write_bytes, ABS_ROUTE_TARGET_FOLDER
from mykeys import bytes_to_RSA_key

def decrypt_file(file_name: str, aes_key: bytes) -> None:
    assert file_name[-4:] == '.enc'

    file_in = open(file_name, 'rb')
    nonce, tag, ciphertext = [ file_in.read(x) for x in (16, 16, -1) ]
    file_in.close()

    cipher = AES.new(aes_key, AES.MODE_EAX, nonce)
    data = cipher.decrypt_and_verify(ciphertext, tag)
    write_bytes(data, file_name[:-4])


def decrypt_file_RSA(file_name: str, priv_key) -> None:
    assert file_name[-4:] == '.enc'

    encrypted_data = read_bytes(file_name)
    cipher = PKCS1_OAEP.new(priv_key)

    decrypted_data = cipher.decrypt(encrypted_data)
    write_bytes(decrypted_data, file_name[:-4])


if __name__ == '__main__':

    TARGET = get_venv_var('TARGET')
    if TARGET == None:
        TARGET = ABS_ROUTE_TARGET_FOLDER

    print('target:', TARGET)

    target_files = all_files(TARGET)

    priv_key = bytes_to_RSA_key(read_bytes('priv_key.bin'))

    decrypt_file_RSA('aes_key.bin.enc', priv_key)

    aes_key = read_bytes('aes_key.bin')

    for file in target_files:
        decrypt_file(file, aes_key)
        delete_file(file)

    delete_file('aes_key.bin.enc')

