from sys import argv
import os
from Crypto.Cipher import AES
from encrypt import all_files, delete_file
from mykeys import read_bytes, write_bytes

def decrypt_file(file_name: str, aes_key: bytes) -> None:
    assert file_name[-4:] == '.enc'
    file_in = open(file_name, 'rb')
    nonce, tag, ciphertext = [ file_in.read(x) for x in (16, 16, -1) ]
    file_in.close()
    cipher = AES.new(aes_key, AES.MODE_EAX, nonce)
    data = cipher.decrypt_and_verify(ciphertext, tag)
    write_bytes(data, file_name[:-4])


if __name__ == '__main__':
    TARGET = None
    if len(argv) == 2 and argv[1] == 'test':
        from dotenv import load_dotenv
        load_dotenv()
        TARGET = os.getenv('TARGET')
    TARGET = '' if TARGET == None else TARGET

    target_files = all_files(TARGET)
    aes_key = read_bytes('aes_key.bin')

    for file in target_files:
        decrypt_file(file, aes_key)
        delete_file(file)
