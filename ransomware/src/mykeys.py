from os.path import isfile
from secrets import choice
from Crypto.Protocol.KDF import PBKDF2
from Crypto.Random import get_random_bytes
from Crypto.PublicKey import RSA
from string import ascii_letters, digits


CHARS = ascii_letters + digits + '+-!@#$%^&*()_[]{};:,.<>?|'


def get_AES_random_key() -> bytes:
    r_passphrase = ''.join(choice(CHARS) for _ in range(64))
    salt = get_random_bytes(32)
    return PBKDF2(r_passphrase, salt, dkLen=32, count=100000)


def write_bytes(bytes_: bytes, file_name: str) -> None:
    with open(file_name, 'wb') as file_out:
        file_out.write(bytes_)


def read_bytes(file_name: str) -> bytes:
    data = None
    with open(file_name, 'rb') as f:
        data = f.read()
    return data


def get_RSA_random_key() -> tuple:
    key = RSA.generate(4096)
    pub_key = key.public_key().export_key()
    priv_key = key.export_key(pkcs=8)
    return (pub_key, priv_key)


bytes_to_RSA_key = lambda bytes_ : RSA.import_key(bytes_)


if __name__ == '__main__':
    pub_f = 'pub_key.bin'
    priv_f = 'priv_key.bin'
    aes_f = 'aes_key.bin'
    keys = isfile(pub_f) and isfile(priv_f) and isfile(aes_f)
    if not keys:
       (pub_key, priv_key) = get_RSA_random_key()
       aes_key = get_AES_random_key()
       write_bytes(pub_key, 'pub_key.bin')
       write_bytes(priv_key, 'priv_key.bin')
       write_bytes(aes_key, 'aes_key.bin')
       print('keys created successfully')
    else:
       print('keys already craeted')
       pub_key_bytes = read_bytes(pub_f)
       aes_key_bytes = read_bytes(aes_f)
       print(bytes_to_RSA_key(pub_key_bytes).export_key())
       print(aes_key_bytes)


